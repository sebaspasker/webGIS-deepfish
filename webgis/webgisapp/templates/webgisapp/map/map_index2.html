<!DOCTYPE html>
<html>
	<head>
		{% load static %}
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="{% static 'css/top_nav.css' %}">
		<link rel="stylesheet" href="{% static 'css/left_bar.css' %}">

		<!-- BOOTSTRAP -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

		<!-- MAPBOX -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css"
      rel="stylesheet"
    />

		<!-- FONT AWESOME -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
	</head>
	<body>
		<header class="p-3 bg-light text-white">
			<div class="container-fluid">
				<div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
					<a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
						<svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use xlink:href="#bootstrap"></use></svg>
					</a>

					<ul class="nav col-12 col-lg-auto col-md-8 col-sm-6 me-lg-auto mb-2 justify-content-center mb-md-0">
						<li><a href="#" class="nav-link px-2 text-secondary">Deepfish</a></li>
					</ul>
					<div class="text-end">
						<div class="flex-shrink-0 dropdown">
							<a class="nav-link dropdown-toggle show" href="#" id="dropdown06" data-bs-toggle="dropdown" aria-expanded="true">
								Dropdown
							</a>
						<ul class="dropdown-menu show" aria-labelledby="dropdown06" data-bs-popper="static">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
						</div>
					</div>
				</div>
			</div>
		</header>
	<main class="d-flex flex-nowrap">
		<div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
				<button type="button" class="btn btn-primary" style="color: white; position: absolute; left: 401px; top: 50%;" data-bs-dismiss="offcanvas" aria-label="Close"><i class="fa fa-angle-left"></i></button>
			<div class="offcanvas-body" style="padding-left: 0px; padding-right:0px; padding-top: 0px;">
				<img id="vessel_picture" style="width:100; height:auto" class="img-fluid" src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.gannett-cdn.com%2F-mm-%2F023895d6d8637785395c6009d739d1234711f23d%2Fc%3D0-234-4608-2837%2Flocal%2F-%2Fmedia%2F2016%2F10%2F03%2FUSATODAY%2FUSATODAY%2F636110981736578798-NWP23to26-262.JPG%3Fwidth%3D3200%26height%3D1808%26fit%3Dcrop%26format%3Dpjpg%26auto%3Dwebp&f=1&nofb=1" alt=""> 
		 			<ul class="nav nav-pills flex-column mb-auto"> 
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					MMSI: {{ MMSI }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Vessel Name: {{ VesselName }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Matricula: {{ Matricula }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					LON: {{ LON }}, LAT: {{ LAT }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					COG: {{ COG }}, SOG: {{ SOG }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					BaseDateTime: {{ BaseDateTime }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					CallSign: {{ CallSign }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Vessel Type: {{ VesselType }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Lenght: {{ Length }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Width: {{ Width }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Cargo: {{ Cargo }}
		 				</li>
		 				<li class="nav-item" style="text-align:left; margin-left:3px">
		 					Transceiver Class: {{ TransceiverClass }}
		 				</li>
		 			</ul> 
					<div style="position: absolute; bottom: 8px; left: 16px; width: 300px">
						<hr>
						<div class="dropdown" >
							<a href="#" class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
								<img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle me-2">
								<strong>mdo</strong>
							</a>
							<ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
								<li><a class="dropdown-item" href="#">New project...</a></li>
								<li><a class="dropdown-item" href="#">Settings</a></li>
								<li><a class="dropdown-item" href="#">Profile</a></li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="#">Sign out</a></li>
							</ul>
						</div>
					</div>
			</div>
		</div>
		<div class="col">
			<button class="btn btn-primary" type="button" style="position:absolute; left:3px; top:50%; z-index:2;" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling"><i class="fa fa-angle-right"></i></button>
			<div class="container-fluid" style="position: absolute; z-index: 2; top: 87.5%; left: 94.0%">
				<a href="{% url 'index' %}">
				<img id="map_icon" class="img-fluid;" src="{% static 'img/map_1.png' %}" style="border-radius:5px; border: 2px solid white;" width="100px" height="100px">
				</a>
			</div>
			<div id="map" style="box-sizing: content-box; margin-top:72px; z-index:1"></div> 
		</div>
	</div>
	{{ collection|json_script:"collection" }}
	{{ collection_individual|json_script:"collection_individual" }}
	{{ type|json_script:"type" }}


	</main>
	<script>
		const layerIDs = [];
		const filterInput = document.getElementById('filter-input');
				data = JSON.parse(document.getElementById('collection').textContent);
				data_individual = JSON.parse(document.getElementById('collection_individual').textContent);
				mapboxgl.accessToken =
					'pk.eyJ1IjoibWFsLXdvb2QiLCJhIjoiY2oyZ2t2em50MDAyMzJ3cnltMDFhb2NzdiJ9.X-D4Wvo5E5QxeP7K_I3O8w';
				const map = new mapboxgl.Map({
					container: 'map',
					style: 'mapbox://styles/mapbox/streets-v11',
					center: [-0.28634550125236236, 38.03759971570147],
					zoom: 10
				});
				map.on('load', () => {
					map.addSource('vessels', {
						'type': 'geojson',
									'data': data
					});

					map.addSource('vessel_points', {
						'type': 'geojson',
									'data': data_individual 
					});

					map.addLayer({
						'id' : 'vessels-points',
						'type' : 'circle',
						'source' : 'vessel_points',
						'paint' : {
							'circle-opacity' : 1,
							'circle-color': ['get', 'Color']
						}
					});

					for (const feature of data.features) {
							const MMSI = feature.properties.MMSI;
							const vesselID = `${MMSI}`;

							if(!map.getLayer(vesselID)) {
									type=JSON.parse(document.getElementById('type').textContent)
									if(type == "pointandline") {
										map.addLayer({
												'id':vesselID,
												'type':'circle',
												'source':'vessels',
												'filter': ['==', 'MMSI', vesselID],
												'paint': {
														'circle-color': ['get', 'Color']
												}			
										});
										layerIDs.push(vesselID)
										map.addLayer({
												'id':vesselID+'line',
												'type':'line',
												'source':'vessels',
												'filter': ['==', 'MMSI', vesselID],
												'paint': {
													'line-color': ['get', 'Color'],
													'line-width': 1
												}
											});
										layerIDs.push(vesselID)
									} else if(type == 'line') {
										map.addLayer({
												'id':vesselID,
												'type':JSON.parse(document.getElementById('type').textContent),
												'source':'vessels',
												'filter': ['==', 'MMSI', vesselID],
												'paint': {
													'line-color': ['get', 'Color'],
													'line-width': 3
												}
											});
										layerIDs.push(vesselID)
									} else {
										map.addLayer({
												'id':vesselID,
												'type':'circle',
												'source':'vessels',
												'filter': ['==', 'MMSI', vesselID],
												'paint': {
														'circle-color': ['get', 'Color']
												}			
										});
										layerIDs.push(vesselID)
									}
								}
						}


				map.on('click', (event) => {
					const features = map.queryRenderedFeatures(event.point, {
						layers: ['vessels-points']
					});

					if (!features.length) {
						return;
					}

				const feature = features[0];

//				document.getElementById("mmsi-lateral").innerHTML = "MMSI: " + feature.properties.MMSI;
//				document.getElementById("vesselname-lateral").innerHTML = "Vessel name: " + feature.properties.VesselName;
//				document.getElementById("matricula-lateral").innerHTML = "Matricula: " + feature.properties.Matricula;
//				document.getElementById("lonlat-lateral").innerHTML = "LON: " + feature.properties.LON + " LAT: " + feature.properties.LAT;
//				document.getElementById("cogsog-lateral").innerHTML = "COG: " + feature.properties.COG + " SOG: " + feature.properties.SOG;
//				document.getElementById("date-lateral").innerHTML = "BaseDateTime: " + feature.properties.BaseDateTime;
//				document.getElementById("type-lateral").innerHTML = "Vessel type: " + feature.properties.VesselType;
//				document.getElementById("length-lateral").innerHTML = "Length: " + feature.properties.Length + " m";
//				document.getElementById("width-lateral").innerHTML = "Width: " + feature.properties.VWidth + " m";
//				document.getElementById("cargo-lateral").innerHTML = "Cargo: " + feature.properties.Cargo;
//				document.getElementById("transceiver-lateral").innerHTML = "Transceiver class: " + feature.properties.TransceiverClass;
//				document.getElementById("callsign-lateral").innerHTML = "Callsign: " + feature.properties.CallSign;

				 
				const popup = new mapboxgl.Popup({ offset: [0, -15] })
					.setLngLat(feature.geometry.coordinates)
					.setHTML(
						`<h3>${feature.properties.MMSI}</h3><p></p>`
					)
					.addTo(map);
				});
						
						});
				

	</script>
	</body>
</html>
